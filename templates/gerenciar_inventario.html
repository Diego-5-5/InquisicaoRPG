{% extends "base.html" %}

{% block title %}Invent√°rio de {{ ficha.nome }} - Sistema de Fichas RPG{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üéí Invent√°rio de {{ ficha.nome }}</h1>
    <p class="page-subtitle">
        Gerencie todos os itens e equipamentos do seu personagem
    </p>
    
    <div style="margin-top: 25px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <a href="{{ url_for('criar_item', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            ‚ûï Adicionar Item
        </a>
        <a href="{{ url_for('visualizar_ficha', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            üëÅÔ∏è Ver Ficha
        </a>
        <a href="{{ url_for('index') }}" class="btn-primary" style="text-decoration: none;">
            üè† Voltar ao In√≠cio
        </a>
    </div>
</div>

<!-- ESTAT√çSTICAS DO INVENT√ÅRIO -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #2196f3;">
        <div style="font-size: 2rem; margin-bottom: 8px;">üì¶</div>
        <div style="font-size: 12px; color: #1565c0; margin-bottom: 4px; font-weight: 600;">TOTAL DE ITENS</div>
        <div style="font-size: 24px; font-weight: 700; color: #0d47a1;">{{ estatisticas.total_itens }}</div>
    </div>
    
    <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #9c27b0;">
        <div style="font-size: 2rem; margin-bottom: 8px;">‚öñÔ∏è</div>
        <div style="font-size: 12px; color: #6a1b9a; margin-bottom: 4px; font-weight: 600;">PESO TOTAL</div>
        <div style="font-size: 24px; font-weight: 700; color: #4a148c;">{{ "%.1f"|format(estatisticas.peso_total) }} kg</div>
    </div>
    
    <div style="background: linear-gradient(135deg, #fff3e0, #ffcc02); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ff9800;">
        <div style="font-size: 2rem; margin-bottom: 8px;">üí∞</div>
        <div style="font-size: 12px; color: #e65100; margin-bottom: 4px; font-weight: 600;">VALOR TOTAL</div>
        <div style="font-size: 24px; font-weight: 700; color: #bf360c;">{{ estatisticas.valor_total }} moedas</div>
    </div>
    
    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ffc107;">
        <div style="font-size: 2rem; margin-bottom: 8px;">üí∞</div>
        <div style="font-size: 12px; color: #856404; margin-bottom: 4px; font-weight: 600;">OURO DISPON√çVEL</div>
        <div style="font-size: 24px; font-weight: 700; color: #6c5700;">{{ ficha.ouro }}</div>
    </div>
</div>

{% if itens %}
    <div style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="color: #2c3e50; margin: 0;">üì¶ Itens do Invent√°rio ({{ itens|length }})</h2>
    </div>
    
    <!-- Filtros -->
    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e9ecef;">
        <h4 style="margin-bottom: 15px; color: #495057;">üîç Filtros</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <select id="filtro-categoria" onchange="filtrarItens()" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
                <option value="">Todas as categorias</option>
                {% set categorias = itens | map(attribute='categoria') | list | unique | sort %}
                {% for categoria in categorias %}
                    <option value="{{ categoria }}">{{ categoria }}</option>
                {% endfor %}
            </select>
            
            <input type="text" id="busca-nome" placeholder="Buscar por nome..." onkeyup="filtrarItens()" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
            
            <select id="ordenar-por" onchange="ordenarItens()" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
                <option value="nome">Ordenar por Nome</option>
                <option value="categoria">Ordenar por Categoria</option>
                <option value="valor">Ordenar por Valor</option>
                <option value="peso">Ordenar por Peso</option>
                <option value="quantidade">Ordenar por Quantidade</option>
            </select>
        </div>
    </div>
    
    <div id="lista-itens" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 24px;">
        {% for item in itens %}
            <div class="card item-inventario" 
                 data-categoria="{{ item.categoria }}" 
                 data-nome="{{ item.nome.lower() }}"
                 data-valor="{{ item.valor }}"
                 data-peso="{{ item.peso }}"
                 data-quantidade="{{ item.quantidade }}"
                 style="position: relative; transition: all 0.3s ease;">
                
                <!-- Badge de categoria -->
                <div style="position: absolute; top: 16px; right: 16px; background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 11px; font-weight: 600;">
                    {{ item.categoria }}
                </div>
                
                <!-- Badge de quantidade (se > 1) -->
                {% if item.quantidade > 1 %}
                    <div style="position: absolute; top: 16px; left: 16px; background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        {{ item.quantidade }}x
                    </div>
                {% endif %}
                
                <!-- Conte√∫do principal -->
                <div style="margin-top: {% if item.quantidade > 1 %}45px{% else %}35px{% endif %};">
                    <h3 style="font-size: 1.3rem; font-weight: 700; color: #2c3e50; margin-bottom: 12px;">
                        {{ item.nome }}
                    </h3>
                    
                    <!-- Descri√ß√£o -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <div style="color: #495057; font-size: 14px; line-height: 1.5;">{{ item.descricao }}</div>
                    </div>
                    
                    <!-- Informa√ß√µes do item -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: #e9ecef; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px; font-weight: 600;">QUANTIDADE</div>
                            <div style="font-size: 16px; font-weight: 700; color: #495057;">{{ item.quantidade }}</div>
                        </div>
                        
                        {% if item.peso > 0 %}
                            <div style="background: #f3e5f5; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #7b1fa2; margin-bottom: 4px; font-weight: 600;">PESO</div>
                                <div style="font-size: 16px; font-weight: 700; color: #6a1b9a;">{{ item.peso }}kg</div>
                            </div>
                        {% endif %}
                        
                        {% if item.valor > 0 %}
                            <div style="background: #fff3e0; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #f57c00; margin-bottom: 4px; font-weight: 600;">VALOR</div>
                                <div style="font-size: 16px; font-weight: 700; color: #e65100;">{{ item.valor }}</div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Valor total se quantidade > 1 -->
                    {% if item.quantidade > 1 and (item.peso > 0 or item.valor > 0) %}
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                            <div style="font-size: 12px; color: #155724; margin-bottom: 4px; font-weight: 600;">TOTAL</div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #155724;">
                                {% if item.peso > 0 %}
                                    <span><strong>Peso:</strong> {{ "%.1f"|format(item.peso * item.quantidade) }}kg</span>
                                {% endif %}
                                {% if item.valor > 0 %}
                                    <span><strong>Valor:</strong> {{ item.valor * item.quantidade }} moedas</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- A√ß√µes -->
                    <div style="display: flex; gap: 8px;">
                        <a href="{{ url_for('editar_item', item_id=item.id) }}" 
                           class="btn-primary" 
                           style="flex: 1; text-align: center; text-decoration: none; padding: 10px; border-radius: 6px; font-size: 13px;">
                            ‚úèÔ∏è Editar
                        </a>
                        <form method="POST" action="{{ url_for('deletar_item', item_id=item.id) }}" 
                              onsubmit="return confirm('Tem certeza que deseja remover {{ item.nome }} do invent√°rio?')" 
                              style="flex: 1;">
                            <button type="submit" 
                                    style="width: 100%; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px; font-size: 13px; cursor: pointer;">
                                üóëÔ∏è Remover
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Timestamp -->
                <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #e9ecef; font-size: 11px; color: #adb5bd; text-align: center;">
                    Adicionado: {{ item.criado_em.split('.')[0] if item.criado_em else 'N/A' }}
                    {% if item.atualizado_em != item.criado_em %}
                        ‚Ä¢ Editado: {{ item.atualizado_em.split('.')[0] if item.atualizado_em else 'N/A' }}
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Estat√≠sticas detalhadas -->
    <div style="margin-top: 40px; background: white; padding: 24px; border-radius: 12px; border: 1px solid #e9ecef;">
        <h4 style="margin-bottom: 20px; color: #2c3e50; font-size: 1.2rem;">üìä An√°lise do Invent√°rio</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            
            <!-- Por categoria -->
            <div>
                <strong style="color: #495057; display: block; margin-bottom: 8px;">üì¶ Por Categoria</strong>
                {% set categoria_stats = {} %}
                {% for item in itens %}
                    {% if categoria_stats.update({item.categoria: categoria_stats.get(item.categoria, 0) + item.quantidade}) %}{% endif %}
                {% endfor %}
                {% for categoria, quantidade in categoria_stats.items() %}
                    <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">
                        {{ categoria }}: <span style="font-weight: 600;">{{ quantidade }} itens</span>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Itens mais valiosos -->
            <div>
                <strong style="color: #495057; display: block; margin-bottom: 8px;">üíé Mais Valiosos</strong>
                {% set itens_valiosos = itens | sort(attribute='valor', reverse=true) | list %}
                {% for item in itens_valiosos[:3] %}
                    {% if item.valor > 0 %}
                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">
                            {{ item.nome }}: <span style="font-weight: 600;">{{ item.valor }} moedas</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- Itens mais pesados -->
            <div>
                <strong style="color: #495057; display: block; margin-bottom: 8px;">‚öñÔ∏è Mais Pesados</strong>
                {% set itens_pesados = itens | sort(attribute='peso', reverse=true) | list %}
                {% for item in itens_pesados[:3] %}
                    {% if item.peso > 0 %}
                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">
                            {{ item.nome }}: <span style="font-weight: 600;">{{ item.peso }}kg</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

{% else %}
    <!-- Estado vazio -->
    <div class="empty-state">
        <div class="empty-state-icon">üéí</div>
        <h3>Invent√°rio vazio</h3>
        <p>{{ ficha.nome }} ainda n√£o possui itens no invent√°rio. Comece adicionando o primeiro item!</p>
        <a href="{{ url_for('criar_item', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none; font-size: 16px;">
            üì¶ Adicionar Primeiro Item
        </a>
    </div>
{% endif %}

<!-- Informa√ß√µes do sistema -->
<div style="margin-top: 40px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 24px; border-radius: 12px; border: 1px solid #dee2e6;">
    <h4 style="margin-bottom: 16px; color: #495057; font-size: 1.1rem;">üéí Sistema de Invent√°rio</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; font-size: 14px; color: #6c757d; line-height: 1.6;">
        <div>
            <strong style="color: #495057;">Categorias Dispon√≠veis:</strong><br>
            Armas, Armaduras, Consum√≠veis, Ferramentas, Tesouros, Geral
        </div>
        <div>
            <strong style="color: #495057;">Informa√ß√µes do Item:</strong><br>
            Nome, descri√ß√£o, categoria, quantidade, peso e valor
        </div>
        <div>
            <strong style="color: #495057;">Estat√≠sticas:</strong><br>
            Peso total, valor total e contagem por categoria
        </div>
        <div>
            <strong style="color: #495057;">Organiza√ß√£o:</strong><br>
            Filtros por categoria e busca por nome
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function filtrarItens() {
        const categoria = document.getElementById('filtro-categoria').value;
        const busca = document.getElementById('busca-nome').value.toLowerCase();
        
        const itens = document.querySelectorAll('.item-inventario');
        let visiveisCount = 0;
        
        itens.forEach(item => {
            const itemCategoria = item.getAttribute('data-categoria');
            const itemNome = item.getAttribute('data-nome');
            
            let mostrar = true;
            
            if (categoria && itemCategoria !== categoria) mostrar = false;
            if (busca && !itemNome.includes(busca)) mostrar = false;
            
            if (mostrar) {
                item.style.display = 'block';
                item.style.opacity = '1';
                item.style.transform = 'scale(1)';
                visiveisCount++;
            } else {
                item.style.display = 'none';
                item.style.opacity = '0';
                item.style.transform = 'scale(0.95)';
            }
        });
        
        // Mostrar mensagem se nenhum item for encontrado
        let mensagem = document.getElementById('nenhum-item');
        if (visiveisCount === 0) {
            if (!mensagem) {
                mensagem = document.createElement('div');
                mensagem.id = 'nenhum-item';
                mensagem.style.cssText = `
                    text-align: center; padding: 40px; background: #f8f9fa; 
                    border-radius: 12px; border: 2px dashed #dee2e6; 
                    color: #6c757d; font-size: 16px;
                `;
                mensagem.innerHTML = 'üîç Nenhum item encontrado com os filtros selecionados.';
                document.getElementById('lista-itens').appendChild(mensagem);
            }
            mensagem.style.display = 'block';
        } else if (mensagem) {
            mensagem.style.display = 'none';
        }
    }
    
    function ordenarItens() {
        const criterio = document.getElementById('ordenar-por').value;
        const container = document.getElementById('lista-itens');
        const itens = Array.from(container.querySelectorAll('.item-inventario'));
        
        itens.sort((a, b) => {
            let valorA, valorB;
            
            switch (criterio) {
                case 'nome':
                    valorA = a.getAttribute('data-nome');
                    valorB = b.getAttribute('data-nome');
                    return valorA.localeCompare(valorB);
                
                case 'categoria':
                    valorA = a.getAttribute('data-categoria');
                    valorB = b.getAttribute('data-categoria');
                    return valorA.localeCompare(valorB);
                
                case 'valor':
                    valorA = parseInt(a.getAttribute('data-valor')) || 0;
                    valorB = parseInt(b.getAttribute('data-valor')) || 0;
                    return valorB - valorA; // Decrescente
                
                case 'peso':
                    valorA = parseFloat(a.getAttribute('data-peso')) || 0;
                    valorB = parseFloat(b.getAttribute('data-peso')) || 0;
                    return valorB - valorA; // Decrescente
                
                case 'quantidade':
                    valorA = parseInt(a.getAttribute('data-quantidade')) || 0;
                    valorB = parseInt(b.getAttribute('data-quantidade')) || 0;
                    return valorB - valorA; // Decrescente
                
                default:
                    return 0;
            }
        });
        
        // Reorganizar os elementos
        itens.forEach(item => container.appendChild(item));
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar efeitos hover nos cards
        const cards = document.querySelectorAll('.item-inventario');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-4px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.08)';
            });
        });
        
        // Anima√ß√£o de entrada dos cards
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Nova Habilidade para {{ ficha.nome }} - Sistema de Fichas RPG{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">‚ú® Nova Habilidade para {{ ficha.nome }}</h1>
    <p class="page-subtitle">
        Crie uma nova habilidade ou magia para seu personagem
    </p>
    
    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <a href="{{ url_for('gerenciar_habilidades', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            ‚öîÔ∏è Ver Habilidades
        </a>
        <a href="{{ url_for('visualizar_ficha', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            üëÅÔ∏è Ver Ficha
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('salvar_habilidade', ficha_id=ficha.id) }}" style="max-width: 1000px; margin: 0 auto;">
    
    <!-- INFORMA√á√ïES B√ÅSICAS -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>üìã Estrutura B√°sica</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome da Habilidade *</label>
                <input type="text" id="nome" name="nome" required placeholder="Ex: Golpe Devastador, Bola de Fogo...">
            </div>
            
            <div class="form-group">
                <label for="nivel">N√≠vel (1-4) *</label>
                <select id="nivel" name="nivel" required>
                    <option value="">Selecione o n√≠vel</option>
                    <option value="1">üü¢ N√≠vel 1 - Iniciante</option>
                    <option value="2">üü° N√≠vel 2 - Intermedi√°rio</option>
                    <option value="3">üü† N√≠vel 3 - Avan√ßado</option>
                    <option value="4">üî¥ N√≠vel 4 - Mestre</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="tipo_fisico_magico">Tipo *</label>
                <select id="tipo_fisico_magico" name="tipo_fisico_magico" required>
                    <option value="">Selecione o tipo</option>
                    <option value="FISICO">‚öîÔ∏è F√≠sico - Baseado em atributos f√≠sicos</option>
                    <option value="MAGICO">üîÆ M√°gico - Usa mana e magia</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="tipo_ativacao">Ativa√ß√£o *</label>
                <select id="tipo_ativacao" name="tipo_ativacao" required>
                    <option value="">Selecione a ativa√ß√£o</option>
                    <option value="ATIVA">‚ö° Ativa - Requer a√ß√£o para usar</option>
                    <option value="PASSIVA">üîÑ Passiva - Sempre ativa</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="tipo_habilidade">Categoria *</label>
                <select id="tipo_habilidade" name="tipo_habilidade" required>
                    <option value="">Selecione a categoria</option>
                    <option value="Ataque">‚öîÔ∏è Ataque - Causa dano</option>
                    <option value="Defesa">üõ°Ô∏è Defesa - Protege ou reduz dano</option>
                    <option value="Suporte">üíö Suporte - Cura ou auxilia</option>
                    <option value="Terreno">üåç Terreno - Modifica ambiente</option>
                </select>
            </div>
        </div>
    </div>

    <!-- MEC√ÇNICAS -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>‚öôÔ∏è Mec√¢nicas</h3>
        </div>
        
        <div class="form-group">
            <label for="proficiencia">Profici√™ncia Respons√°vel *</label>
            <select id="proficiencia" name="proficiencia" required>
                <option value="">Selecione a profici√™ncia</option>
                
                <optgroup label="üéØ Profici√™ncias Gerais">
                    <option value="Sobreviv√™ncia">üèïÔ∏è Sobreviv√™ncia</option>
                    <option value="Bot√¢nica">üå± Bot√¢nica</option>
                    <option value="Culin√°ria">üç≥ Culin√°ria</option>
                    <option value="Religi√£o">‚õ™ Religi√£o</option>
                    <option value="Pescaria">üé£ Pescaria</option>
                    <option value="Ferraria">üî® Ferraria</option>
                    <option value="Artesanato">üé® Artesanato</option>
                    <option value="Mixologia">üç∫ Mixologia</option>
                    <option value="M√∫sica">üéµ M√∫sica</option>
                    <option value="Jogos de Azar">üé≤ Jogos de Azar</option>
                    <option value="Rataria">üêÄ Rataria</option>
                    <option value="Navega√ß√£o">‚õµ Navega√ß√£o</option>
                    <option value="Sacratismo">‚ú® Sacratismo</option>
                    <option value="Demonologia">üëπ Demonologia</option>
                    <option value="Guerra">‚öîÔ∏è Guerra</option>
                    <option value="Acrobacia">ü§∏ Acrobacia</option>
                </optgroup>
                
                <optgroup label="‚öîÔ∏è Profici√™ncias de Combate">
                    <option value="Combate Desarmado">üëä Combate Desarmado</option>
                    <option value="Armas Leves">üó°Ô∏è Armas Leves</option>
                    <option value="Armas Pesadas">‚öîÔ∏è Armas Pesadas</option>
                    <option value="Armas Longa Dist√¢ncia">üèπ Armas Longa Dist√¢ncia</option>
                    <option value="Arremesso">üéØ Arremesso</option>
                </optgroup>
                
                <optgroup label="üîÆ Per√≠cias M√°gicas">
                    <option value="Maguslogia">üìö Maguslogia</option>
                    <option value="Magia Elemental">üåä Magia Elemental</option>
                    <option value="Magia Est√≠mulo">üí´ Magia Est√≠mulo</option>
                    <option value="Magia Territorial">üó∫Ô∏è Magia Territorial</option>
                </optgroup>
            </select>
        </div>
        
        <div class="form-group">
            <label for="efeito">Efeito *</label>
            <textarea id="efeito" name="efeito" rows="3" required placeholder="Descreva o efeito mec√¢nico da habilidade (dano, cura, b√¥nus, etc.)"></textarea>
        </div>
        
        <div class="form-group">
            <label for="descricao">Descri√ß√£o *</label>
            <textarea id="descricao" name="descricao" rows="4" required placeholder="Descreva como a habilidade/magia √© executada, sua apar√™ncia visual, sensa√ß√µes, etc."></textarea>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="custo">Custo</label>
                <input type="text" id="custo" name="custo" placeholder="Ex: 5 Mana, 2 Vigor, 1 A√ß√£o...">
            </div>
            
            <div class="form-group">
                <label for="dt_atributo">DT + Atributo</label>
                <input type="text" id="dt_atributo" name="dt_atributo" placeholder="Ex: DT15 + For√ßa, DT12 + Magia...">
            </div>
            
            <div class="form-group">
                <label for="alcance">Alcance</label>
                <input type="text" id="alcance" name="alcance" placeholder="Ex: Toque, 10 metros, √Ä dist√¢ncia...">
            </div>
        </div>
    </div>

    <!-- CONFIGURA√á√ÉO DE MAGIA -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>‚ú® Configura√ß√£o de Magia</h3>
            <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 14px;">
                Marque se esta habilidade √© uma magia e preencha os campos espec√≠ficos
            </p>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #495057; cursor: pointer;">
                <input type="checkbox" id="eh_magia" name="eh_magia" onchange="toggleCamposMagia()" style="transform: scale(1.2);">
                <span>Esta √© uma magia</span>
            </label>
        </div>
        
        <div id="campos_magia" style="display: none;">
            <div class="form-group">
                <label for="elemento_magico">Elemento M√°gico</label>
                <select id="elemento_magico" name="elemento_magico">
                    <option value="">Selecione o elemento</option>
                    <option value="Fogo">üî• Fogo - Poder destrutivo</option>
                    <option value="Agua">üíß √Ågua - Fluidez e adapta√ß√£o</option>
                    <option value="Terra">üåç Terra - Estabilidade e for√ßa</option>
                    <option value="Natureza">üåø Natureza - Vida e crescimento</option>
                    <option value="Vento">üí® Vento - Velocidade e liberdade</option>
                    <option value="Som">üîä Som - Vibra√ß√£o e harmonia</option>
                    <option value="Sagrado">‚ú® Sagrado - Pureza e prote√ß√£o</option>
                    <option value="Obscuro">üåë Obscuro - Trevas e mist√©rio</option>
                    <option value="Sangue">ü©∏ Sangue - Vida e sacrif√≠cio</option>
                    <option value="Mental">üß† Mental - Psique e consci√™ncia</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="conjuracao">Conjura√ß√£o</label>
                <textarea id="conjuracao" name="conjuracao" rows="3" placeholder="Como o personagem realiza a magia? Descreva cifras, gestos, componentes materiais, runas, ferramentas espec√≠ficas..."></textarea>
            </div>
        </div>
    </div>

    <!-- PREVIEW DA HABILIDADE -->
    <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
        <div class="card-header">
            <h3>üëÅÔ∏è Preview da Habilidade</h3>
            <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 14px;">
                Visualiza√ß√£o em tempo real da habilidade sendo criada
            </p>
        </div>
        
        <div id="preview-habilidade" style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
            <div style="text-align: center; color: #6c757d; font-style: italic;">
                Preencha os campos acima para ver o preview da habilidade
            </div>
        </div>
    </div>

    <!-- BOT√ïES DE A√á√ÉO -->
    <div style="text-align: center; margin-top: 40px; padding: 30px; background: #f8f9fa; border-radius: 12px;">
        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <button type="submit" class="btn-primary" style="font-size: 16px; padding: 16px 32px; border: none; cursor: pointer;">
                ‚ú® Criar Habilidade
            </button>
            <a href="{{ url_for('gerenciar_habilidades', ficha_id=ficha.id) }}" class="btn-secondary" style="font-size: 16px; padding: 16px 32px; text-decoration: none;">
                ‚ùå Cancelar
            </a>
        </div>
        <p style="margin-top: 16px; color: #6c757d; font-size: 14px;">
            A habilidade pode ser editada posteriormente
        </p>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    function toggleCamposMagia() {
        const checkbox = document.getElementById('eh_magia');
        const campos = document.getElementById('campos_magia');
        
        if (checkbox.checked) {
            campos.style.display = 'block';
            campos.style.opacity = '0';
            setTimeout(() => {
                campos.style.opacity = '1';
                campos.style.transition = 'opacity 0.3s ease';
            }, 10);
        } else {
            campos.style.opacity = '0';
            setTimeout(() => {
                campos.style.display = 'none';
            }, 300);
        }
        
        atualizarPreview();
    }
    
    function atualizarPreview() {
        const nome = document.getElementById('nome').value || 'Nome da Habilidade';
        const nivel = document.getElementById('nivel').value || '1';
        const tipo = document.getElementById('tipo_fisico_magico').value || 'FISICO';
        const ativacao = document.getElementById('tipo_ativacao').value || 'ATIVA';
        const categoria = document.getElementById('tipo_habilidade').value || 'Ataque';
        const proficiencia = document.getElementById('proficiencia').value || 'Profici√™ncia';
        const efeito = document.getElementById('efeito').value || 'Efeito da habilidade...';
        const descricao = document.getElementById('descricao').value || 'Descri√ß√£o da habilidade...';
        const custo = document.getElementById('custo').value;
        const dt = document.getElementById('dt_atributo').value;
        const alcance = document.getElementById('alcance').value;
        const ehMagia = document.getElementById('eh_magia').checked;
        const elemento = document.getElementById('elemento_magico').value;
        const conjuracao = document.getElementById('conjuracao').value;
        
        const nivelCores = {
            '1': '#28a745',
            '2': '#ffc107', 
            '3': '#fd7e14',
            '4': '#dc3545'
        };
        
        const preview = document.getElementById('preview-habilidade');
        
        preview.innerHTML = `
            <div style="position: relative;">
                <!-- Badge de n√≠vel -->
                <div style="position: absolute; top: 0; right: 0; background: ${nivelCores[nivel] || '#6c757d'}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">
                    N√≠vel ${nivel}
                </div>
                
                <!-- Tipo de habilidade/magia -->
                <div style="position: absolute; top: 0; left: 0; background: ${ehMagia ? '#6f42c1' : '#495057'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                    ${ehMagia ? '‚ú® MAGIA' : '‚öîÔ∏è HABILIDADE'}
                </div>
                
                <div style="margin-top: 35px;">
                    <h3 style="font-size: 1.3rem; font-weight: 700; color: #2c3e50; margin-bottom: 12px;">
                        ${nome}
                    </h3>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                            ${tipo}
                        </span>
                        <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                            ${ativacao}
                        </span>
                        <span style="background: #e8f5e8; color: #388e3c; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                            ${categoria}
                        </span>
                        ${elemento ? `<span style="background: #fff3e0; color: #f57c00; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${elemento}</span>` : ''}
                    </div>
                    
                    <!-- Profici√™ncia -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px; font-weight: 600;">PROFICI√äNCIA RESPONS√ÅVEL</div>
                        <div style="font-weight: 600; color: #495057;">${proficiencia}</div>
                    </div>
                    
                    <!-- Efeito -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px; font-weight: 600;">EFEITO</div>
                        <div style="color: #495057; font-size: 14px; line-height: 1.4;">${efeito}</div>
                    </div>
                    
                    <!-- Descri√ß√£o -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px; font-weight: 600;">DESCRI√á√ÉO</div>
                        <div style="color: #6c757d; font-size: 13px; line-height: 1.5;">${descricao}</div>
                    </div>
                    
                    <!-- Informa√ß√µes de combate -->
                    ${(custo || dt || alcance) ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 15px; font-size: 12px;">
                            ${custo ? `
                                <div style="background: #fff3cd; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="color: #856404; font-weight: 600;">CUSTO</div>
                                    <div style="color: #6c5700;">${custo}</div>
                                </div>
                            ` : ''}
                            ${dt ? `
                                <div style="background: #d1ecf1; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="color: #0c5460; font-weight: 600;">DT</div>
                                    <div style="color: #0a4a53;">${dt}</div>
                                </div>
                            ` : ''}
                            ${alcance ? `
                                <div style="background: #d4edda; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="color: #155724; font-weight: 600;">ALCANCE</div>
                                    <div style="color: #0f4419;">${alcance}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Conjura√ß√£o para magias -->
                    ${(ehMagia && conjuracao) ? `
                        <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #9c27b0;">
                            <div style="font-size: 12px; color: #4a148c; margin-bottom: 4px; font-weight: 600;">‚ú® CONJURA√á√ÉO</div>
                            <div style="color: #6a1b9a; font-size: 13px; line-height: 1.4;">${conjuracao}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Atualizar preview quando campos mudarem
        const campos = [
            'nome', 'nivel', 'tipo_fisico_magico', 'tipo_ativacao', 'tipo_habilidade',
            'proficiencia', 'efeito', 'descricao', 'custo', 'dt_atributo', 'alcance',
            'eh_magia', 'elemento_magico', 'conjuracao'
        ];
        
        campos.forEach(campo => {
            const elemento = document.getElementById(campo);
            if (elemento) {
                elemento.addEventListener('input', atualizarPreview);
                elemento.addEventListener('change', atualizarPreview);
            }
        });
        
        // Preview inicial
        atualizarPreview();
        
        // Valida√ß√£o do formul√°rio
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            const camposObrigatorios = [
                { id: 'nome', nome: 'Nome da habilidade' },
                { id: 'nivel', nome: 'N√≠vel' },
                { id: 'tipo_fisico_magico', nome: 'Tipo (F√≠sico/M√°gico)' },
                { id: 'tipo_ativacao', nome: 'Ativa√ß√£o' },
                { id: 'tipo_habilidade', nome: 'Categoria' },
                { id: 'proficiencia', nome: 'Profici√™ncia' },
                { id: 'efeito', nome: 'Efeito' },
                { id: 'descricao', nome: 'Descri√ß√£o' }
            ];
            
            for (let campo of camposObrigatorios) {
                const valor = document.getElementById(campo.id).value.trim();
                if (!valor) {
                    e.preventDefault();
                    alert(`Por favor, preencha o campo: ${campo.nome}`);
                    document.getElementById(campo.id).focus();
                    return;
                }
            }
            
            // Validar nome m√≠nimo
            const nome = document.getElementById('nome').value.trim();
            if (nome.length < 2) {
                e.preventDefault();
                alert('O nome da habilidade deve ter pelo menos 2 caracteres!');
                document.getElementById('nome').focus();
                return;
            }
            
            // Confirmar cria√ß√£o
            if (!confirm('Confirma a cria√ß√£o da habilidade?')) {
                e.preventDefault();
            }
        });
        
        // Efeitos visuais nos inputs
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.borderColor = '#667eea';
                this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
            });
            
            input.addEventListener('blur', function() {
                this.style.borderColor = '#e9ecef';
                this.style.boxShadow = 'none';
            });
        });
        
        // Sugest√µes autom√°ticas baseadas no tipo
        document.getElementById('tipo_fisico_magico').addEventListener('change', function() {
            const proficienciaSelect = document.getElementById('proficiencia');
            const tipo = this.value;
            
            if (tipo === 'FISICO') {
                // Sugerir profici√™ncias de combate para habilidades f√≠sicas
                const opcoesFisicas = [
                    'Combate Desarmado', 'Armas Leves', 'Armas Pesadas', 
                    'Armas Longa Dist√¢ncia', 'Arremesso', 'Guerra', 'Acrobacia'
                ];
                
                // Destacar op√ß√µes f√≠sicas
                Array.from(proficienciaSelect.options).forEach(option => {
                    if (opcoesFisicas.includes(option.value)) {
                        option.style.fontWeight = '600';
                        option.style.color = '#dc3545';
                    } else {
                        option.style.fontWeight = 'normal';
                        option.style.color = '#495057';
                    }
                });
            } else if (tipo === 'MAGICO') {
                // Sugerir profici√™ncias m√°gicas
                const opcoesMagicas = [
                    'Maguslogia', 'Magia Elemental', 'Magia Est√≠mulo', 
                    'Magia Territorial', 'Sacratismo', 'Demonologia'
                ];
                
                // Destacar op√ß√µes m√°gicas
                Array.from(proficienciaSelect.options).forEach(option => {
                    if (opcoesMagicas.includes(option.value)) {
                        option.style.fontWeight = '600';
                        option.style.color = '#6f42c1';
                    } else {
                        option.style.fontWeight = 'normal';
                        option.style.color = '#495057';
                    }
                });
            }
        });
        
        // Auto-marcar como magia quando tipo m√°gico √© selecionado
        document.getElementById('tipo_fisico_magico').addEventListener('change', function() {
            if (this.value === 'MAGICO') {
                const checkbox = document.getElementById('eh_magia');
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    toggleCamposMagia();
                }
            }
        });
        
        // Sugest√µes de custo baseadas no tipo
        document.getElementById('tipo_fisico_magico').addEventListener('change', function() {
            const custoInput = document.getElementById('custo');
            const tipo = this.value;
            
            if (tipo === 'MAGICO') {
                custoInput.placeholder = 'Ex: 5 Mana, 10 Mana, 2 Vigor + 3 Mana...';
            } else if (tipo === 'FISICO') {
                custoInput.placeholder = 'Ex: 2 Vigor, 1 A√ß√£o, 3 Vigor + 1 A√ß√£o...';
            }
        });
        
        // Contadores de caracteres
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            const contador = document.createElement('div');
            contador.style.cssText = 'font-size: 12px; color: #6c757d; text-align: right; margin-top: 5px;';
            contador.textContent = `0 caracteres`;
            textarea.parentNode.appendChild(contador);
            
            textarea.addEventListener('input', function() {
                const length = this.value.length;
                contador.textContent = `${length} caracteres`;
                
                if (length > 500) {
                    contador.style.color = '#dc3545';
                } else if (length > 300) {
                    contador.style.color = '#ffc107';
                } else {
                    contador.style.color = '#6c757d';
                }
            });
        });
    });
</script>
{% endblock %}
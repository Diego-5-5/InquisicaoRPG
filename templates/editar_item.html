{% extends "base.html" %}

{% block title %}Editar {{ item.nome }} - Sistema de Fichas RPG{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">✏️ Editar {{ item.nome }}</h1>
    <p class="page-subtitle">
        Faça as alterações necessárias no item do inventário de {{ ficha.nome }}
    </p>
    
    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <a href="{{ url_for('gerenciar_inventario', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            🎒 Ver Inventário
        </a>
        <a href="{{ url_for('visualizar_ficha', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            👁️ Ver Ficha
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('atualizar_item', item_id=item.id) }}" style="max-width: 800px; margin: 0 auto;">
    
    <!-- INFORMAÇÕES BÁSICAS -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>📋 Informações do Item</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome do Item *</label>
                <input type="text" id="nome" name="nome" value="{{ item.nome }}" required placeholder="Ex: Espada de Ferro, Poção de Cura...">
            </div>
            
            <div class="form-group">
                <label for="categoria">Categoria</label>
                <select id="categoria" name="categoria">
                    <option value="Geral" {% if item.categoria == 'Geral' %}selected{% endif %}>📦 Geral</option>
                    <option value="Armas" {% if item.categoria == 'Armas' %}selected{% endif %}>⚔️ Armas</option>
                    <option value="Armaduras" {% if item.categoria == 'Armaduras' %}selected{% endif %}>🛡️ Armaduras</option>
                    <option value="Consumíveis" {% if item.categoria == 'Consumíveis' %}selected{% endif %}>🧪 Consumíveis</option>
                    <option value="Ferramentas" {% if item.categoria == 'Ferramentas' %}selected{% endif %}>🔧 Ferramentas</option>
                    <option value="Tesouros" {% if item.categoria == 'Tesouros' %}selected{% endif %}>💎 Tesouros</option>
                    <option value="Materiais" {% if item.categoria == 'Materiais' %}selected{% endif %}>📜 Materiais</option>
                    <option value="Livros" {% if item.categoria == 'Livros' %}selected{% endif %}>📚 Livros</option>
                    <option value="Jóias" {% if item.categoria == 'Jóias' %}selected{% endif %}>💍 Jóias</option>
                    <option value="Roupas" {% if item.categoria == 'Roupas' %}selected{% endif %}>👕 Roupas</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="descricao">Descrição *</label>
            <textarea id="descricao" name="descricao" rows="4" required placeholder="Descreva o item...">{{ item.descricao }}</textarea>
        </div>
    </div>

    <!-- PROPRIEDADES -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>📊 Propriedades</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="quantidade">Quantidade</label>
                <input type="number" id="quantidade" name="quantidade" value="{{ item.quantidade }}" min="1" max="9999">
            </div>
            
            <div class="form-group">
                <label for="peso">Peso (kg)</label>
                <input type="number" id="peso" name="peso" value="{{ item.peso }}" min="0" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="valor">Valor (moedas)</label>
                <input type="number" id="valor" name="valor" value="{{ item.valor }}" min="0">
            </div>
        </div>
        
        <!-- Calculadora de valor total -->
        <div id="calculo-total" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #28a745; {% if item.quantidade <= 1 and item.peso <= 0 and item.valor <= 0 %}display: none;{% endif %}">
            <h5 style="color: #155724; margin-bottom: 10px;">💰 Cálculo Total</h5>
            <div style="display: flex; justify-content: space-between; font-size: 14px; color: #155724;">
                <span id="peso-total">Peso Total: {{ "%.1f"|format(item.peso * item.quantidade) }} kg</span>
                <span id="valor-total">Valor Total: {{ item.valor * item.quantidade }} moedas</span>
            </div>
        </div>
    </div>

    <!-- PREVIEW DO ITEM -->
    <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
        <div class="card-header">
            <h3>👁️ Preview do Item</h3>
            <p style="color: #6c757d; margin: 8px 0 0 0; font-size: 14px;">
                Visualização em tempo real das alterações
            </p>
        </div>
        
        <div id="preview-item" style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
            <!-- Preview será preenchido via JavaScript -->
        </div>
    </div>

    <!-- BOTÕES DE AÇÃO -->
    <div style="text-align: center; margin-top: 40px; padding: 30px; background: #f8f9fa; border-radius: 12px;">
        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <button type="submit" class="btn-primary" style="font-size: 16px; padding: 16px 32px; border: none; cursor: pointer;">
                💾 Salvar Alterações
            </button>
            <a href="{{ url_for('gerenciar_inventario', ficha_id=ficha.id) }}" class="btn-secondary" style="font-size: 16px; padding: 16px 32px; text-decoration: none;">
                ❌ Cancelar
            </a>
        </div>
        <p style="margin-top: 16px; color: #6c757d; font-size: 14px;">
            Confirme as alterações antes de salvar
        </p>
    </div>
</form>

<!-- Informações do Item -->
<div class="card" style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
    <div class="card-header">
        <h3>📊 Informações do Item</h3>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">ID DO ITEM</div>
            <div style="font-size: 20px; font-weight: 700; color: #2c3e50;">#{{ item.id }}</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">ADICIONADO EM</div>
            <div style="font-size: 14px; font-weight: 600; color: #495057;">{{ item.criado_em.split('.')[0] if item.criado_em else 'N/A' }}</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">ÚLTIMA ATUALIZAÇÃO</div>
            <div style="font-size: 14px; font-weight: 600; color: #495057;">{{ item.atualizado_em.split('.')[0] if item.atualizado_em else 'N/A' }}</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function calcularTotal() {
        const quantidade = parseInt(document.getElementById('quantidade').value) || 0;
        const peso = parseFloat(document.getElementById('peso').value) || 0;
        const valor = parseInt(document.getElementById('valor').value) || 0;
        
        const pesoTotal = peso * quantidade;
        const valorTotal = valor * quantidade;
        
        const calculoDiv = document.getElementById('calculo-total');
        
        if (quantidade > 1 && (peso > 0 || valor > 0)) {
            calculoDiv.style.display = 'block';
            document.getElementById('peso-total').textContent = `Peso Total: ${pesoTotal.toFixed(1)} kg`;
            document.getElementById('valor-total').textContent = `Valor Total: ${valorTotal} moedas`;
        } else {
            calculoDiv.style.display = 'none';
        }
        
        atualizarPreview();
    }
    
    function atualizarPreview() {
        const nome = document.getElementById('nome').value || 'Nome do Item';
        const categoria = document.getElementById('categoria').value || 'Geral';
        const descricao = document.getElementById('descricao').value || 'Descrição do item...';
        const quantidade = parseInt(document.getElementById('quantidade').value) || 1;
        const peso = parseFloat(document.getElementById('peso').value) || 0;
        const valor = parseInt(document.getElementById('valor').value) || 0;
        
        const categoriaIcons = {
            'Geral': '📦',
            'Armas': '⚔️',
            'Armaduras': '🛡️',
            'Consumíveis': '🧪',
            'Ferramentas': '🔧',
            'Tesouros': '💎',
            'Materiais': '📜',
            'Livros': '📚',
            'Jóias': '💍',
            'Roupas': '👕'
        };
        
        const preview = document.getElementById('preview-item');
        
        preview.innerHTML = `
            <div style="position: relative;">
                <!-- Badge de categoria -->
                <div style="position: absolute; top: 0; right: 0; background: #667eea; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">
                    ${categoriaIcons[categoria] || '📦'} ${categoria}
                </div>
                
                <!-- Badge de quantidade (se > 1) -->
                ${quantidade > 1 ? `
                    <div style="position: absolute; top: 0; left: 0; background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ${quantidade}x
                    </div>
                ` : ''}
                
                <div style="margin-top: ${quantidade > 1 ? '40px' : '30px'};">
                    <h3 style="font-size: 1.3rem; font-weight: 700; color: #2c3e50; margin-bottom: 15px;">
                        ${nome}
                    </h3>
                    
                    <!-- Descrição -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <div style="color: #495057; font-size: 14px; line-height: 1.5;">${descricao}</div>
                    </div>
                    
                    <!-- Propriedades -->
                    ${(quantidade > 1 || peso > 0 || valor > 0) ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 12px; margin-bottom: 15px;">
                            <div style="background: #e9ecef; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px; font-weight: 600;">QUANTIDADE</div>
                                <div style="font-size: 16px; font-weight: 700; color: #495057;">${quantidade}</div>
                            </div>
                            
                            ${peso > 0 ? `
                                <div style="background: #f3e5f5; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 10px; color: #7b1fa2; margin-bottom: 4px; font-weight: 600;">PESO</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #6a1b9a;">${peso}kg</div>
                                </div>
                            ` : ''}
                            
                            ${valor > 0 ? `
                                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 10px; color: #f57c00; margin-bottom: 4px; font-weight: 600;">VALOR</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #e65100;">${valor}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Totais se quantidade > 1 -->
                    ${(quantidade > 1 && (peso > 0 || valor > 0)) ? `
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="font-size: 12px; color: #155724; margin-bottom: 4px; font-weight: 600;">TOTAL</div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #155724;">
                                ${peso > 0 ? `<span><strong>Peso:</strong> ${(peso * quantidade).toFixed(1)}kg</span>` : ''}
                                ${valor > 0 ? `<span><strong>Valor:</strong> ${valor * quantidade} moedas</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Atualizar preview quando campos mudarem
        const campos = ['nome', 'categoria', 'descricao', 'quantidade', 'peso', 'valor'];
        
        campos.forEach(campo => {
            const elemento = document.getElementById(campo);
            if (elemento) {
                elemento.addEventListener('input', function() {
                    atualizarPreview();
                    if (['quantidade', 'peso', 'valor'].includes(campo)) {
                        calcularTotal();
                    }
                });
                elemento.addEventListener('change', function() {
                    atualizarPreview();
                    if (['quantidade', 'peso', 'valor'].includes(campo)) {
                        calcularTotal();
                    }
                });
            }
        });
        
        // Preview e cálculo inicial
        atualizarPreview();
        calcularTotal();
        
        // Validação do formulário
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            const nome = document.getElementById('nome').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            
            if (!nome) {
                e.preventDefault();
                alert('Por favor, preencha o nome do item!');
                document.getElementById('nome').focus();
                return;
            }
            
            if (nome.length < 2) {
                e.preventDefault();
                alert('O nome do item deve ter pelo menos 2 caracteres!');
                document.getElementById('nome').focus();
                return;
            }
            
            if (!descricao) {
                e.preventDefault();
                alert('Por favor, preencha a descrição do item!');
                document.getElementById('descricao').focus();
                return;
            }
            
            if (descricao.length < 10) {
                e.preventDefault();
                alert('A descrição deve ter pelo menos 10 caracteres!');
                document.getElementById('descricao').focus();
                return;
            }
            
            // Confirmar alterações
            if (!confirm('Tem certeza que deseja salvar as alterações no item?')) {
                e.preventDefault();
            }
        });
        
        // Efeitos visuais nos inputs
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                if (!this.readOnly) {
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
                }
            });
            
            input.addEventListener('blur', function() {
                this.style.borderColor = '#e9ecef';
                this.style.boxShadow = 'none';
            });
        });
        
        // Indicador de mudanças não salvas
        let hasChanges = false;
        
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                hasChanges = true;
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = 'Você tem alterações não salvas. Tem certeza que deseja sair?';
            }
        });
        
        // Remover aviso ao submeter
        form.addEventListener('submit', function() {
            hasChanges = false;
        });
        
        // Contador de caracteres para a descrição
        const descricaoTextarea = document.getElementById('descricao');
        const contador = document.createElement('div');
        contador.style.cssText = 'font-size: 12px; color: #6c757d; text-align: right; margin-top: 5px;';
        contador.textContent = `${descricaoTextarea.value.length} caracteres`;
        descricaoTextarea.parentNode.appendChild(contador);
        
        descricaoTextarea.addEventListener('input', function() {
            const length = this.value.length;
            contador.textContent = `${length} caracteres`;
            
            if (length < 10) {
                contador.style.color = '#dc3545';
            } else if (length > 200) {
                contador.style.color = '#ffc107';
            } else {
                contador.style.color = '#28a745';
            }
        });
    });
</script>
{% endblock %}
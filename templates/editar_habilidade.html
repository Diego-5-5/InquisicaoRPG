{% extends "base.html" %}

{% block title %}Editar {{ habilidade.nome }} - Sistema de Fichas RPG{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">âœï¸ Editar {{ habilidade.nome }}</h1>
    <p class="page-subtitle">
        FaÃ§a as alteraÃ§Ãµes necessÃ¡rias na habilidade de {{ ficha.nome }}
    </p>
    
    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <a href="{{ url_for('gerenciar_habilidades', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            âš”ï¸ Ver Habilidades
        </a>
        <a href="{{ url_for('visualizar_ficha', ficha_id=ficha.id) }}" class="btn-primary" style="text-decoration: none;">
            ğŸ‘ï¸ Ver Ficha
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('atualizar_habilidade', habilidade_id=habilidade.id) }}" style="max-width: 1000px; margin: 0 auto;">
    
    <!-- INFORMAÃ‡Ã•ES BÃSICAS -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>ğŸ“‹ Estrutura BÃ¡sica</h3>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome da Habilidade *</label>
                <input type="text" id="nome" name="nome" value="{{ habilidade.nome }}" required placeholder="Ex: Golpe Devastador, Bola de Fogo...">
            </div>
            
            <div class="form-group">
                <label for="nivel">NÃ­vel (1-4) *</label>
                <select id="nivel" name="nivel" required>
                    <option value="">Selecione o nÃ­vel</option>
                    <option value="1" {% if habilidade.nivel == 1 %}selected{% endif %}>ğŸŸ¢ NÃ­vel 1 - Iniciante</option>
                    <option value="2" {% if habilidade.nivel == 2 %}selected{% endif %}>ğŸŸ¡ NÃ­vel 2 - IntermediÃ¡rio</option>
                    <option value="3" {% if habilidade.nivel == 3 %}selected{% endif %}>ğŸŸ  NÃ­vel 3 - AvanÃ§ado</option>
                    <option value="4" {% if habilidade.nivel == 4 %}selected{% endif %}>ğŸ”´ NÃ­vel 4 - Mestre</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="tipo_fisico_magico">Tipo *</label>
                <select id="tipo_fisico_magico" name="tipo_fisico_magico" required>
                    <option value="">Selecione o tipo</option>
                    <option value="FISICO" {% if habilidade.tipo_fisico_magico == 'FISICO' %}selected{% endif %}>âš”ï¸ FÃ­sico - Baseado em atributos fÃ­sicos</option>
                    <option value="MAGICO" {% if habilidade.tipo_fisico_magico == 'MAGICO' %}selected{% endif %}>ğŸ”® MÃ¡gico - Usa mana e magia</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="tipo_ativacao">AtivaÃ§Ã£o *</label>
                <select id="tipo_ativacao" name="tipo_ativacao" required>
                    <option value="">Selecione a ativaÃ§Ã£o</option>
                    <option value="ATIVA" {% if habilidade.tipo_ativacao == 'ATIVA' %}selected{% endif %}>âš¡ Ativa - Requer aÃ§Ã£o para usar</option>
                    <option value="PASSIVA" {% if habilidade.tipo_ativacao == 'PASSIVA' %}selected{% endif %}>ğŸ”„ Passiva - Sempre ativa</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="tipo_habilidade">Categoria *</label>
                <select id="tipo_habilidade" name="tipo_habilidade" required>
                    <option value="">Selecione a categoria</option>
                    <option value="Ataque" {% if habilidade.tipo_habilidade == 'Ataque' %}selected{% endif %}>âš”ï¸ Ataque - Causa dano</option>
                    <option value="Defesa" {% if habilidade.tipo_habilidade == 'Defesa' %}selected{% endif %}>ğŸ›¡ï¸ Defesa - Protege ou reduz dano</option>
                    <option value="Suporte" {% if habilidade.tipo_habilidade == 'Suporte' %}selected{% endif %}>ğŸ’š Suporte - Cura ou auxilia</option>
                    <option value="Terreno" {% if habilidade.tipo_habilidade == 'Terreno' %}selected{% endif %}>ğŸŒ Terreno - Modifica ambiente</option>
                </select>
            </div>
        </div>
    </div>

    <!-- MECÃ‚NICAS -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>âš™ï¸ MecÃ¢nicas</h3>
        </div>
        
        <div class="form-group">
            <label for="proficiencia">ProficiÃªncia ResponsÃ¡vel *</label>
            <select id="proficiencia" name="proficiencia" required>
                <option value="">Selecione a proficiÃªncia</option>
                
                <optgroup label="ğŸ¯ ProficiÃªncias Gerais">
                    <option value="SobrevivÃªncia" {% if habilidade.proficiencia == 'SobrevivÃªncia' %}selected{% endif %}>ğŸ•ï¸ SobrevivÃªncia</option>
                    <option value="BotÃ¢nica" {% if habilidade.proficiencia == 'BotÃ¢nica' %}selected{% endif %}>ğŸŒ± BotÃ¢nica</option>
                    <option value="CulinÃ¡ria" {% if habilidade.proficiencia == 'CulinÃ¡ria' %}selected{% endif %}>ğŸ³ CulinÃ¡ria</option>
                    <option value="ReligiÃ£o" {% if habilidade.proficiencia == 'ReligiÃ£o' %}selected{% endif %}>â›ª ReligiÃ£o</option>
                    <option value="Pescaria" {% if habilidade.proficiencia == 'Pescaria' %}selected{% endif %}>ğŸ£ Pescaria</option>
                    <option value="Ferraria" {% if habilidade.proficiencia == 'Ferraria' %}selected{% endif %}>ğŸ”¨ Ferraria</option>
                    <option value="Artesanato" {% if habilidade.proficiencia == 'Artesanato' %}selected{% endif %}>ğŸ¨ Artesanato</option>
                    <option value="Mixologia" {% if habilidade.proficiencia == 'Mixologia' %}selected{% endif %}>ğŸº Mixologia</option>
                    <option value="MÃºsica" {% if habilidade.proficiencia == 'MÃºsica' %}selected{% endif %}>ğŸµ MÃºsica</option>
                    <option value="Jogos de Azar" {% if habilidade.proficiencia == 'Jogos de Azar' %}selected{% endif %}>ğŸ² Jogos de Azar</option>
                    <option value="Rataria" {% if habilidade.proficiencia == 'Rataria' %}selected{% endif %}>ğŸ€ Rataria</option>
                    <option value="NavegaÃ§Ã£o" {% if habilidade.proficiencia == 'NavegaÃ§Ã£o' %}selected{% endif %}>â›µ NavegaÃ§Ã£o</option>
                    <option value="Sacratismo" {% if habilidade.proficiencia == 'Sacratismo' %}selected{% endif %}>âœ¨ Sacratismo</option>
                    <option value="Demonologia" {% if habilidade.proficiencia == 'Demonologia' %}selected{% endif %}>ğŸ‘¹ Demonologia</option>
                    <option value="Guerra" {% if habilidade.proficiencia == 'Guerra' %}selected{% endif %}>âš”ï¸ Guerra</option>
                    <option value="Acrobacia" {% if habilidade.proficiencia == 'Acrobacia' %}selected{% endif %}>ğŸ¤¸ Acrobacia</option>
                </optgroup>
                
                <optgroup label="âš”ï¸ ProficiÃªncias de Combate">
                    <option value="Combate Desarmado" {% if habilidade.proficiencia == 'Combate Desarmado' %}selected{% endif %}>ğŸ‘Š Combate Desarmado</option>
                    <option value="Armas Leves" {% if habilidade.proficiencia == 'Armas Leves' %}selected{% endif %}>ğŸ—¡ï¸ Armas Leves</option>
                    <option value="Armas Pesadas" {% if habilidade.proficiencia == 'Armas Pesadas' %}selected{% endif %}>âš”ï¸ Armas Pesadas</option>
                    <option value="Armas Longa DistÃ¢ncia" {% if habilidade.proficiencia == 'Armas Longa DistÃ¢ncia' %}selected{% endif %}>ğŸ¹ Armas Longa DistÃ¢ncia</option>
                    <option value="Arremesso" {% if habilidade.proficiencia == 'Arremesso' %}selected{% endif %}>ğŸ¯ Arremesso</option>
                </optgroup>
                
                <optgroup label="ğŸ”® PerÃ­cias MÃ¡gicas">
                    <option value="Maguslogia" {% if habilidade.proficiencia == 'Maguslogia' %}selected{% endif %}>ğŸ“š Maguslogia</option>
                    <option value="Magia Elemental" {% if habilidade.proficiencia == 'Magia Elemental' %}selected{% endif %}>ğŸŒŠ Magia Elemental</option>
                    <option value="Magia EstÃ­mulo" {% if habilidade.proficiencia == 'Magia EstÃ­mulo' %}selected{% endif %}>ğŸ’« Magia EstÃ­mulo</option>
                    <option value="Magia Territorial" {% if habilidade.proficiencia == 'Magia Territorial' %}selected{% endif %}>ğŸ—ºï¸ Magia Territorial</option>
                </optgroup>
            </select>
        </div>
        
        <div class="form-group">
            <label for="efeito">Efeito *</label>
            <textarea id="efeito" name="efeito" rows="3" required placeholder="Descreva o efeito mecÃ¢nico da habilidade">{{ habilidade.efeito }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="descricao">DescriÃ§Ã£o *</label>
            <textarea id="descricao" name="descricao" rows="4" required placeholder="Descreva como a habilidade/magia Ã© executada">{{ habilidade.descricao }}</textarea>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="custo">Custo</label>
                <input type="text" id="custo" name="custo" value="{{ habilidade.custo or '' }}" placeholder="Ex: 5 Mana, 2 Vigor...">
            </div>
            
            <div class="form-group">
                <label for="dt_atributo">DT + Atributo</label>
                <input type="text" id="dt_atributo" name="dt_atributo" value="{{ habilidade.dt_atributo or '' }}" placeholder="Ex: DT15 + ForÃ§a...">
            </div>
            
            <div class="form-group">
                <label for="alcance">Alcance</label>
                <input type="text" id="alcance" name="alcance" value="{{ habilidade.alcance or '' }}" placeholder="Ex: Toque, 10 metros...">
            </div>
        </div>
    </div>

    <!-- CONFIGURAÃ‡ÃƒO DE MAGIA -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <h3>âœ¨ ConfiguraÃ§Ã£o de Magia</h3>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #495057; cursor: pointer;">
                <input type="checkbox" id="eh_magia" name="eh_magia" {% if habilidade.eh_magia %}checked{% endif %} onchange="toggleCamposMagia()" style="transform: scale(1.2);">
                <span>Esta Ã© uma magia</span>
            </label>
        </div>
        
        <div id="campos_magia" style="{% if not habilidade.eh_magia %}display: none;{% endif %}">
            <div class="form-group">
                <label for="elemento_magico">Elemento MÃ¡gico</label>
                <select id="elemento_magico" name="elemento_magico">
                    <option value="">Selecione o elemento</option>
                    <option value="Fogo" {% if habilidade.elemento_magico == 'Fogo' %}selected{% endif %}>ğŸ”¥ Fogo - Poder destrutivo</option>
                    <option value="Agua" {% if habilidade.elemento_magico == 'Agua' %}selected{% endif %}>ğŸ’§ Ãgua - Fluidez e adaptaÃ§Ã£o</option>
                    <option value="Terra" {% if habilidade.elemento_magico == 'Terra' %}selected{% endif %}>ğŸŒ Terra - Estabilidade e forÃ§a</option>
                    <option value="Natureza" {% if habilidade.elemento_magico == 'Natureza' %}selected{% endif %}>ğŸŒ¿ Natureza - Vida e crescimento</option>
                    <option value="Vento" {% if habilidade.elemento_magico == 'Vento' %}selected{% endif %}>ğŸ’¨ Vento - Velocidade e liberdade</option>
                    <option value="Som" {% if habilidade.elemento_magico == 'Som' %}selected{% endif %}>ğŸ”Š Som - VibraÃ§Ã£o e harmonia</option>
                    <option value="Sagrado" {% if habilidade.elemento_magico == 'Sagrado' %}selected{% endif %}>âœ¨ Sagrado - Pureza e proteÃ§Ã£o</option>
                    <option value="Obscuro" {% if habilidade.elemento_magico == 'Obscuro' %}selected{% endif %}>ğŸŒ‘ Obscuro - Trevas e mistÃ©rio</option>
                    <option value="Sangue" {% if habilidade.elemento_magico == 'Sangue' %}selected{% endif %}>ğŸ©¸ Sangue - Vida e sacrifÃ­cio</option>
                    <option value="Mental" {% if habilidade.elemento_magico == 'Mental' %}selected{% endif %}>ğŸ§  Mental - Psique e consciÃªncia</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="conjuracao">ConjuraÃ§Ã£o</label>
                <textarea id="conjuracao" name="conjuracao" rows="3" placeholder="Como o personagem realiza a magia?">{{ habilidade.conjuracao or '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- BOTÃ•ES DE AÃ‡ÃƒO -->
    <div style="text-align: center; margin-top: 40px; padding: 30px; background: #f8f9fa; border-radius: 12px;">
        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <button type="submit" class="btn-primary" style="font-size: 16px; padding: 16px 32px; border: none; cursor: pointer;">
                ğŸ’¾ Salvar AlteraÃ§Ãµes
            </button>
            <a href="{{ url_for('gerenciar_habilidades', ficha_id=ficha.id) }}" class="btn-secondary" style="font-size: 16px; padding: 16px 32px; text-decoration: none;">
                âŒ Cancelar
            </a>
        </div>
        <p style="margin-top: 16px; color: #6c757d; font-size: 14px;">
            Confirme as alteraÃ§Ãµes antes de salvar
        </p>
    </div>
</form>

<!-- InformaÃ§Ãµes da Habilidade -->
<div class="card" style="margin-top: 30px; max-width: 1000px; margin-left: auto; margin-right: auto;">
    <div class="card-header">
        <h3>ğŸ“Š InformaÃ§Ãµes da Habilidade</h3>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">ID DA HABILIDADE</div>
            <div style="font-size: 20px; font-weight: 700; color: #2c3e50;">#{{ habilidade.id }}</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">CRIADA EM</div>
            <div style="font-size: 14px; font-weight: 600; color: #495057;">{{ habilidade.criado_em.split('.')[0] if habilidade.criado_em else 'N/A' }}</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 10px;">
            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 600;">ÃšLTIMA ATUALIZAÃ‡ÃƒO</div>
            <div style="font-size: 14px; font-weight: 600; color: #495057;">{{ habilidade.atualizado_em.split('.')[0] if habilidade.atualizado_em else 'N/A' }}</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCamposMagia() {
        const checkbox = document.getElementById('eh_magia');
        const campos = document.getElementById('campos_magia');
        
        if (checkbox.checked) {
            campos.style.display = 'block';
            campos.style.opacity = '0';
            setTimeout(() => {
                campos.style.opacity = '1';
                campos.style.transition = 'opacity 0.3s ease';
            }, 10);
        } else {
            campos.style.opacity = '0';
            setTimeout(() => {
                campos.style.display = 'none';
            }, 300);
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // ValidaÃ§Ã£o do formulÃ¡rio
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            const camposObrigatorios = [
                { id: 'nome', nome: 'Nome da habilidade' },
                { id: 'nivel', nome: 'NÃ­vel' },
                { id: 'tipo_fisico_magico', nome: 'Tipo (FÃ­sico/MÃ¡gico)' },
                { id: 'tipo_ativacao', nome: 'AtivaÃ§Ã£o' },
                { id: 'tipo_habilidade', nome: 'Categoria' },
                { id: 'proficiencia', nome: 'ProficiÃªncia' },
                { id: 'efeito', nome: 'Efeito' },
                { id: 'descricao', nome: 'DescriÃ§Ã£o' }
            ];
            
            for (let campo of camposObrigatorios) {
                const valor = document.getElementById(campo.id).value.trim();
                if (!valor) {
                    e.preventDefault();
                    alert(`Por favor, preencha o campo: ${campo.nome}`);
                    document.getElementById(campo.id).focus();
                    return;
                }
            }
            
            // Validar nome mÃ­nimo
            const nome = document.getElementById('nome').value.trim();
            if (nome.length < 2) {
                e.preventDefault();
                alert('O nome da habilidade deve ter pelo menos 2 caracteres!');
                document.getElementById('nome').focus();
                return;
            }
            
            // Confirmar alteraÃ§Ãµes
            if (!confirm('Tem certeza que deseja salvar as alteraÃ§Ãµes na habilidade?')) {
                e.preventDefault();
            }
        });
        
        // Efeitos visuais nos inputs
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                if (!this.readOnly) {
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
                }
            });
            
            input.addEventListener('blur', function() {
                this.style.borderColor = '#e9ecef';
                this.style.boxShadow = 'none';
            });
        });
        
        // Indicador de mudanÃ§as nÃ£o salvas
        let hasChanges = false;
        
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                hasChanges = true;
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = 'VocÃª tem alteraÃ§Ãµes nÃ£o salvas. Tem certeza que deseja sair?';
            }
        });
        
        // Remover aviso ao submeter
        form.addEventListener('submit', function() {
            hasChanges = false;
        });
    });
</script>
{% endblock %}